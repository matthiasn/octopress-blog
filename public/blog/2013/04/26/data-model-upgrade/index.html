
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ReactiveMongo 0.9 and Lossless Persistence - Matthias Nehlsen</title>
  <meta name="author" content="Matthias Nehlsen">

  
  <meta name="description" content="Initially I parsed the Tweets in the BirdWatch application into instances of a Tweet case class upon ingestion and then used that case class &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://matthiasnehlsen.com/blog/2013/04/26/data-model-upgrade">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Matthias Nehlsen" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,300,700' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40261983-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Matthias Nehlsen</a></h1>
  
    <h2>Reactive Data Processing Blog</h2>
    
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:matthiasnehlsen.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">ReactiveMongo 0.9 and Lossless Persistence</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-26T13:48:00+02:00" pubdate data-updated="true">04/26/2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Initially I parsed the Tweets in the <strong><a href="http://birdwatch.matthiasnehlsen.com">BirdWatch</a></strong> application into instances of a Tweet case class upon ingestion and then used that case class representation throughout, including for database persistence. Then I realized that that was actually not a good idea. Using a case class for passing around information in the application is very convenient and useful. But for the persistence, I argue that we cannot afford to be opinionated about what to keep and what to throw away. I fixed this together with the planned migration to <strong><a href="http://reactivemongo.org">ReactiveMongo</a></strong> version 0.9 in the latest commits, storing each  observable fact coming from the <strong><a href="https://dev.twitter.com/docs/streaming-apis">Twitter Streaming API</a></strong> in its entirety.</p>

<!-- more -->


<p>Any data model will almost invariably be wrong in the future as we cannot predict what we will want to analyze later. We can always change the data model at a later point and from then on store a different interpretation of the observable fact, but then we would not have complete historic information when we want to test our hypotheses on retrospective data. The solution for this is to store the Tweets in their complete <strong><a href="http://tools.ietf.org/html/rfc4627">JSON</a></strong> representation. <strong><a href="http://www.mongodb.org">MongoDB</a></strong> is a great choice for this as it allows indexing our data while leaving the <strong><a href="http://tools.ietf.org/html/rfc4627">JSON</a></strong> structure intact. We get the best of two worlds. With this lossless persistence we can always reconstruct the observable fact from the database while at the same time being able to quickly search through a potentially large dataset.</p>

<p>I also wanted to upgrade <strong><a href="http://reactivemongo.org">ReactiveMongo</a></strong> in order to fix a previous problem with Killcursors. Version 0.9 entails some changes in the API, so it was a good idea to tackle the upgrade and the Tweet persistence layer together. Let&#8217;s go through some of the changes:</p>

<figure class='code'><figcaption><span>Mongo Connection in Version 0.8</span><a href='https://github.com/matthiasn/BirdWatch/blob/53b79386ef49d80a1d4d1eae1086b9aff5485fa2/app/utils/Mongo.scala'>Mongo.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Mongo connection object */</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Mongo</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">connection</span> <span class="k">=</span> <span class="nc">MongoConnection</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">&quot;localhost:27017&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">db</span> <span class="k">=</span> <span class="n">connection</span><span class="o">(</span><span class="s">&quot;BirdWatch&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Mongo Connection in Version 0.9</span><a href='https://github.com/matthiasn/BirdWatch/blob/2738bfdafb2a2367a79177b615adb58ce5d51c5b/app/utils/Mongo.scala'>Mongo.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Mongo connection object */</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Mongo</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">driver</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MongoDriver</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">connection</span> <span class="k">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">connection</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">&quot;localhost:27017&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">db</span> <span class="k">=</span> <span class="n">connection</span><span class="o">(</span><span class="s">&quot;BirdWatch&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong><a href="http://reactivemongo.org">ReactiveMongo</a></strong> now uses an instance of the <strong><a href="https://github.com/zenexity/ReactiveMongo/blob/7d2328a337a9092d31801180b97e271a343abf29/driver/src/main/scala/api/api.scala">MongoDriver</a></strong> class and its connection method. The <strong><a href="https://github.com/zenexity/ReactiveMongo/blob/7d2328a337a9092d31801180b97e271a343abf29/driver/src/main/scala/api/api.scala">MongoConnection</a></strong> class still exists, but I couldn&#8217;t get it to work for some reason.</p>

<p>I have moved the Tweet collection and basic query and insert methods into a Tweet companion object, with the intention of turning this into a lightweight <strong><a href="http://en.wikipedia.org/wiki/Data_access_object">DAO (Data Access Object)</a></strong> for Tweets:</p>

<figure class='code'><figcaption><span>Tweet Companion Object</span><a href='https://github.com/matthiasn/BirdWatch/blob/290c609cccbf17076074e1eb2fa4e31bb350ca37/app/models/Tweet.scala'>Tweet.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Data Access Object for Tweets*/</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Tweet</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">rawTweets</span><span class="k">:</span> <span class="kt">JSONCollection</span> <span class="o">=</span> <span class="nc">Mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;rawTweets&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">insertJson</span><span class="o">(</span><span class="n">json</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span> <span class="k">=</span> <span class="n">rawTweets</span><span class="o">.</span><span class="n">insert</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span><span class="n">json</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/** get collection size from MongoDB (fast) */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">command</span><span class="o">(</span><span class="nc">Count</span><span class="o">(</span><span class="s">&quot;rawTweets&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/** Query latest tweets (lazily evaluated stream, result could be of arbitrary size) */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">jsonLatestN</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">cursor</span><span class="k">:</span> <span class="kt">Cursor</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="k">=</span> <span class="n">rawTweets</span>
</span><span class='line'>      <span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;text&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;$exists&quot;</span> <span class="o">-&gt;</span> <span class="kc">true</span><span class="o">)))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">sort</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">cursor</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span>
</span><span class='line'>    <span class="n">cursor</span><span class="o">.</span><span class="n">toList</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Storing the <strong><a href="http://tools.ietf.org/html/rfc4627">JSON</a></strong> from Twitter not only prevents us from throwing away data we might need in the future, it is also much simpler than having to deal with implicit <strong><a href="https://github.com/zenexity/ReactiveMongo/blob/7d2328a337a9092d31801180b97e271a343abf29/bson/src/main/scala/handlers.scala">BSONReader</a></strong> and <strong><a href="https://github.com/zenexity/ReactiveMongo/blob/7d2328a337a9092d31801180b97e271a343abf29/bson/src/main/scala/handlers.scala">BSONWriter</a></strong> objects as was previously the case:</p>

<figure class='code'><figcaption><span>BSON implicits (with 0.8)</span><a href='https://github.com/matthiasn/BirdWatch/blob/f51dac075a6d287b58e55771497b4fd6aa00f32a/app/models/TweetImplicits.scala'>TweetImplicits.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">TweetBSONWriter</span> <span class="k">extends</span> <span class="nc">BSONWriter</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">toBSON</span><span class="o">(</span><span class="n">t</span><span class="k">:</span> <span class="kt">Tweet</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nc">BSONDocument</span><span class="o">(</span>
</span><span class='line'>        <span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="nc">BSONObjectID</span><span class="o">.</span><span class="n">generate</span><span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;tweet_id&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONLong</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">tweet_id</span><span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;screen_name&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONString</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">screen_name</span><span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;text&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONString</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">text</span><span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;wordCount&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONInteger</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">wordCount</span><span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;charCount&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONInteger</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">charCount</span><span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;location&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONString</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">location</span><span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;profile_image_url&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONString</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">profile_image_url</span><span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;geo&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONString</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)),</span>
</span><span class='line'>        <span class="s">&quot;created_at&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONDateTime</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">getMillis</span><span class="o">)</span>
</span><span class='line'>      <span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">TweetBSONReader</span> <span class="k">extends</span> <span class="nc">BSONReader</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">fromBSON</span><span class="o">(</span><span class="n">document</span><span class="k">:</span> <span class="kt">BSONDocument</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tweet</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">doc</span> <span class="k">=</span> <span class="n">document</span><span class="o">.</span><span class="n">toTraversable</span>
</span><span class='line'>      <span class="nc">Tweet</span><span class="o">(</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONLong</span><span class="o">](</span><span class="s">&quot;tweet_id&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">value</span><span class="o">,</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONString</span><span class="o">](</span><span class="s">&quot;screen_name&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">value</span><span class="o">,</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONString</span><span class="o">](</span><span class="s">&quot;text&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">value</span><span class="o">,</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONInteger</span><span class="o">](</span><span class="s">&quot;wordCount&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">value</span><span class="o">,</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONInteger</span><span class="o">](</span><span class="s">&quot;charCount&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">value</span><span class="o">,</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONString</span><span class="o">](</span><span class="s">&quot;location&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">value</span><span class="o">,</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONString</span><span class="o">](</span><span class="s">&quot;profile_image_url&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">value</span><span class="o">,</span>
</span><span class='line'>        <span class="nc">None</span><span class="o">,</span>
</span><span class='line'>        <span class="k">new</span> <span class="nc">DateTime</span><span class="o">(</span><span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONDateTime</span><span class="o">](</span><span class="s">&quot;created_at&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">.</span><span class="n">value</span><span class="o">),</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">BSONObjectID</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead we just parse a <strong><a href="http://tools.ietf.org/html/rfc4627">JSON</a></strong> string from Twitter and insert the parsed <strong><a href="https://github.com/playframework/Play20/blob/2.1.1/framework/src/play/src/main/scala/play/api/libs/json/JsValue.scala">JsValue</a></strong> into the <strong><a href="https://github.com/zenexity/Play-ReactiveMongo/blob/a7164a1ac0832680ca0f4c3da0b6949ffea282b0/src/main/scala/play/modules/reactivemongo/jsoncollection.scala">JSONCollection</a></strong>:</p>

<figure class='code'><figcaption><span>Inserting into database</span><a href='https://github.com/matthiasn/BirdWatch/blob/e33ce62bb36b4a1228c2f1519de60ef3d65482bd/app/actors/TwitterClient.scala'>TwitterClient.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="k">val</span> <span class="n">json</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">chunkString</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/** persist any valid JSON from Twitter Streaming API */</span>
</span><span class='line'>  <span class="nc">Tweet</span><span class="o">.</span><span class="n">insertJson</span><span class="o">(</span><span class="n">json</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is really all there is to storing <strong><a href="http://tools.ietf.org/html/rfc4627">JSON</a></strong> into MongoDB now. I don&#8217;t have to worry about additional fields or other changes in the Twitter Streaming API. If it is valid <strong><a href="http://tools.ietf.org/html/rfc4627">JSON</a></strong>, it will find its way into the database. Major changes to the API might break parsing into Tweets, but they would not break database persistence.</p>

<p>Error and status messages from Twitter also come as <strong><a href="http://tools.ietf.org/html/rfc4627">JSON</a></strong>, so they are stored as well:</p>

<figure class='code'><figcaption><span>JavaScript query in MongoDB shell </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span> <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;â€¦&quot;</span><span class="p">),</span> <span class="s2">&quot;disconnect&quot;</span> <span class="o">:</span>
</span><span class='line'>  <span class="p">{</span> <span class="s2">&quot;code&quot;</span> <span class="o">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;stream_name&quot;</span> <span class="o">:</span> <span class="s2">&quot;_MNehlsen-statuses237381&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;reason&quot;</span> <span class="o">:</span> <span class="s2">&quot;admin logout&quot;</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Querying is more concise than before, making use of Json.obj instead of BSONDocuments:</p>

<figure class='code'><figcaption><span>OLD: Query for latest Tweets</span><a href='https://github.com/matthiasn/BirdWatch/blob/53b79386ef49d80a1d4d1eae1086b9aff5485fa2/app/controllers/Twitter.scala'>Twitter.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">latestTweetQuery</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">query</span> <span class="k">=</span> <span class="nc">QueryBuilder</span><span class="o">().</span><span class="n">query</span><span class="o">(</span><span class="nc">BSONDocument</span><span class="o">(</span><span class="s">&quot;created_at&quot;</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nc">BSONDocument</span><span class="o">(</span><span class="s">&quot;$lte&quot;</span> <span class="o">-&gt;</span> <span class="nc">BSONDateTime</span><span class="o">(</span><span class="nc">DateTime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">getMillis</span><span class="o">))))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">sort</span><span class="o">(</span><span class="s">&quot;created_at&quot;</span> <span class="o">-&gt;</span> <span class="nc">SortOrder</span><span class="o">.</span><span class="nc">Descending</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">cursor</span> <span class="k">=</span> <span class="nc">Mongo</span><span class="o">.</span><span class="n">tweets</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
</span><span class='line'>  <span class="n">cursor</span><span class="o">.</span><span class="n">toList</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>NEW: Query for latest Tweets</span><a href='https://github.com/matthiasn/BirdWatch/blob/4abf8f2fe50986b3dd695998a553b8a9888fce71/app/models/Tweet.scala'>Tweet.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">jsonLatestN</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">cursor</span><span class="k">:</span> <span class="kt">Cursor</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="k">=</span> <span class="n">rawTweets</span>
</span><span class='line'>    <span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;text&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;$exists&quot;</span> <span class="o">-&gt;</span> <span class="kc">true</span><span class="o">)))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">sort</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">cursor</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span>
</span><span class='line'>  <span class="n">cursor</span><span class="o">.</span><span class="n">toList</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This looks much neater and is also close to the syntax in the MongoDB JavaScript shell:</p>

<figure class='code'><figcaption><span>JavaScript query in MongoDB shell </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">rawTweets</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;text&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;$exists&quot;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">sort</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Curly braces get replaced by Json.obj() and the colon gets replaced by &#8220;->&#8221;. Other than that, the syntax is very close. Note the &#8220;$exists&#8221; part. This limits the results to only Tweets (and potentially error and status messages that have a &#8220;text&#8221; field, but I have not encountered those).</p>

<p>The usage above with generating a List from the cursor works fine for small n, but for larger results sets (say hundreds of thousands of items) it would be a bad idea to build the list in memory first. Luckily ReactiveMongo allows us to stream the results. That itself is not new, but since version 0.9 we can limit the number of results, making this much more useful for a latestN scenario:</p>

<figure class='code'><figcaption><span>Enumerating cursor of Tweets</span><a href='https://github.com/matthiasn/BirdWatch/blob/466cce67a38265e311970466b3bf5529fda54f12/app/models/Tweet.scala'>Tweet.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Enumerate latest Tweets (descending order) into specified Iteratee.</span>
</span><span class='line'><span class="cm"> * @param n number of results to enumerate over</span>
</span><span class='line'><span class="cm"> **/</span>
</span><span class='line'><span class="k">def</span> <span class="n">enumJsonLatestN</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">cursor</span><span class="k">:</span> <span class="kt">Cursor</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="k">=</span> <span class="n">rawTweets</span>
</span><span class='line'>    <span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;text&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;$exists&quot;</span> <span class="o">-&gt;</span> <span class="kc">true</span><span class="o">)))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">sort</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">cursor</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span>
</span><span class='line'>  <span class="n">cursor</span><span class="o">.</span><span class="n">enumerate</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this we create an Enumerator of JsObjects that streams the results into an Iteratee. The usage of this is simple once we understand what this pattern means. Check out my previous <strong><a href="http://matthiasnehlsen.com/blog/2013/04/23/iteratee-can-i-have-that-in-a-sentence/">Iteratee article</a></strong>, hope it helps a little bit.</p>

<p>This allows us to stream results into an Iteratee that will do whatever we need, in this case just doing a simple foreach:</p>

<figure class='code'><figcaption><span>Attaching Iteratee to Enumerator </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">dbTweetIteratee</span> <span class="k">=</span> <span class="nc">Iteratee</span><span class="o">.</span><span class="n">foreach</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">json</span> <span class="k">=&gt;</span> <span class="nc">TweetReads</span><span class="o">.</span><span class="n">reads</span><span class="o">(</span><span class="n">json</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">JsSuccess</span><span class="o">(</span><span class="n">t</span><span class="k">:</span> <span class="kt">Tweet</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="n">tweetChannel</span><span class="o">.</span><span class="n">push</span><span class="o">(</span><span class="nc">WordCount</span><span class="o">.</span><span class="n">wordsChars</span><span class="o">(</span><span class="n">t</span><span class="o">))</span> <span class="c1">// word and char count for each t</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">JsError</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">json</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nc">Tweet</span><span class="o">.</span><span class="n">enumJsonLatestN</span><span class="o">(</span><span class="mi">500</span><span class="o">)(</span><span class="n">dbTweetIteratee</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I currently do not enumerate the results into an Iteratee because the Tweets would appear in the wrong order in the UI and I cannot easily reverse the direction in which the Tweets are enumerated without an auto-incrementing counter in MongoDB to determine from where to start enumerating in ascending order (from position [collectionsize - n]). But this is more a problem of the UI, the next versions will certainly make use of this pattern.</p>

<p>The only thing I was still missing is an easy way to get the size of a collection. In the shell we would write:</p>

<figure class='code'><figcaption><span>JavaScript query in MongoDB shell </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">rawTweets</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;text&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;$exists&quot;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">}</span> <span class="p">).</span><span class="nx">count</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Turns out that in ReactiveMongo, we can use the Count command for this, which returns a Future[Int] with the result (see Tweet.scala above).
This allows us to do something upon return of the collection size in a non-blocking way:</p>

<figure class='code'><figcaption><span>Using Count Command</span><a href='https://github.com/matthiasn/BirdWatch/blob/fd44fe45163233746b8caacc0dbba5c815e3f964/app/actors/TwitterClient.scala'>TwitterClient.scala </a></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'>  <span class="nc">Tweet</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;Tweets: &quot;</span> <span class="o">+</span> <span class="n">c</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great stuff, I really like <strong><a href="http://reactivemongo.org">ReactiveMongo</a></strong>. The documentation has also gotten a lot better in 0.9, compared to previous versions. Nonetheless it takes some source code reading to find some of the good stuff. I&#8217;d be more than to happy help out here and contribute to the project documentation.</p>

<p>-Matthias</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Matthias Nehlsen</span></span>

      








  


<time datetime="2013-04-26T13:48:00+02:00" pubdate data-updated="true">04/26/2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://matthiasnehlsen.com/blog/2013/04/26/data-model-upgrade/" data-via="_MNehlsen" data-counturl="http://matthiasnehlsen.com/blog/2013/04/26/data-model-upgrade/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/04/23/iteratee-can-i-have-that-in-a-sentence/" title="Previous Post: Iteratee: can I have that in a sentence?">&laquo; Iteratee: can I have that in a sentence?</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/05/01/server-sent-events-vs-websockets/" title="Next Post: Server Sent Events vs. WebSockets">Server Sent Events vs. WebSockets &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    
<section>
	<span>
		<img src="http://www.gravatar.com/avatar/3f6cb2a9b1057c35f284174063835d41?s=250" alt="Gravatar of Matthias Nehlsen " title="Gravatar of Matthias Nehlsen" />
	</span>
</section>
<section>
  <h1>About Me</h1>
  <p>Hello everyone. My name is Matthias Nehlsen and I am learning functional programming, data visualization and real-time information processing.</p>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/11/load-testing-server-sent-event-streams/">Load Testing Server Sent Event Streams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/01/server-sent-events-vs-websockets/">Server Sent Events vs. WebSockets</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/26/data-model-upgrade/">ReactiveMongo 0.9 and Lossless Persistence</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/23/iteratee-can-i-have-that-in-a-sentence/">Iteratee: can I have that in a sentence?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/hello-world/">Hello World</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li><a href="https://github.com/matthiasn/birdwatch">BirdWatch</a>&nbsp;
      <iframe src="http://ghbtns.com/github-btn.html?user=matthiasn&repo=birdwatch&type=watch&count=true"
        allowtransparency="true" frameborder="0" scrolling="0" width="86" height="20"></iframe>
      <p>Reactive web application using Play Framework 2.1 for consuming and visualizing live Tweets from the Twitter Streaming API.</p>
    </li>
    <li><a href="https://github.com/matthiasn/sse-perf">sse-perf</a>&nbsp;
      <iframe src="http://ghbtns.com/github-btn.html?user=matthiasn&repo=sse-perf&type=watch&count=true"
        allowtransparency="true" frameborder="0" scrolling="0" width="86" height="20"></iframe>
      <p>Reactive web application using Play Framework 2.1 for load testing Server Sent Event streams (or other HTTP connections that deliver information in chunks).</p>
    </li>
  </ul>
</section><section>
    <h1>Subscribe</h1>
    <div id="mc_embed_signup">
      <form action="http://matthiasnehlsen.us7.list-manage1.com/subscribe/post?u=798fd7b50a1d9cc58be41c2af&amp;id=eb7a7193c5" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div class="mc-field-group">
          <label for="mce-EMAIL">Enter your email to receive updates</label>
          <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="you@email.com" />
        </div>
        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
      <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </form>
    <br />
  </div>
</section><section>
  <a href="https://twitter.com/_MNehlsen" class="twitter-follow-button" data-show-count="false" data-size="small">Follow @_MNehlsen</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<br />
<a href="http://de.linkedin.com/pub/matthias-nehlsen/24/a5b/9b5">
<img src="http://www.linkedin.com/img/webpromo/btn_viewmy_160x25.png" width="160" height="25" style="border:0 none" alt="View Matthias Nehlsen's profile on LinkedIn">
</a>

</section>

<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/100986586701798521209?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Matthias Nehlsen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'matthiasnehlsen';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://matthiasnehlsen.com/blog/2013/04/26/data-model-upgrade/';
        var disqus_url = 'http://matthiasnehlsen.com/blog/2013/04/26/data-model-upgrade/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
